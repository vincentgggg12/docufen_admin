{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "databaseAccounts_docufen_staging_name": {
      "type": "String"
    },
    "privateDnsZones_privatelink_documents_azure_com_name": {
      "type": "String"
    },
    "privateDnsZones_privatelink_vaultcore_azure_net_name": {
      "type": "String"
    },
    "privateEndpoints_cosmosstagingendpoint_name": {
      "type": "String"
    },
    "privateEndpoints_keyvaultstagingendpoint_name": {
      "type": "String"
    },
    "registries_docufenstaging_name": {
      "type": "String"
    },
    "serverfarms_docufenAppServicePlanstaging_name": {
      "type": "String"
    },
    "sites_docufen_staging_name": {
      "type": "String"
    },
    "staticSites_docufenapp_staging_name": {
      "type": "String"
    },
    "storageAccounts_docufenstagingstorage_name": {
      "type": "String"
    },
    "systemTopics_docufenstagingstorage_f33197b9_a5d1_4f96_a661_7b8ffa72c06c_name": {
      "type": "String"
    },
    "vaults_docufen_staging_name": {
      "type": "String"
    },
    "virtualNetworks_vnet_staging_name": {
      "type": "String"
    },
    "containerApps_docufen_admin_name": {
      "type": "String",
      "defaultValue": "docufen-admin"
    },
    "managedEnvironments_name": {
      "type": "String",
      "defaultValue": "docufen-container-env"
    },
    "workspaces_containerapp_name": {
      "type": "String",
      "defaultValue": "docufen-logs"
    },
    "containerImage": {
      "type": "String",
      "defaultValue": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
      "metadata": {
        "description": "Container image for the admin interface"
      }
    },
    "containerPort": {
      "type": "Int",
      "defaultValue": 80,
      "metadata": {
        "description": "Port the container listens on"
      }
    },
    "containerAppSubnetName": {
      "type": "String",
      "defaultValue": "ContainerAppSubnet"
    },
    "githubUsername": {
      "type": "String",
      "defaultValue": "",
      "metadata": {
        "description": "GitHub username for ghcr.io authentication (optional)"
      }
    },
    "githubToken": {
      "type": "SecureString",
      "defaultValue": "",
      "metadata": {
        "description": "GitHub PAT for ghcr.io authentication (optional)"
      }
    }
  },
  "resources": [
    {
      "apiVersion": "2025-03-01-preview",
      "location": "westeurope",
      "name": "[parameters('registries_docufenstaging_name')]",
      "properties": {
        "adminUserEnabled": true,
        "anonymousPullEnabled": false,
        "autoGeneratedDomainNameLabelScope": "Unsecure",
        "dataEndpointEnabled": false,
        "encryption": {
          "status": "disabled"
        },
        "metadataSearch": "Disabled",
        "networkRuleBypassOptions": "AzureServices",
        "policies": {
          "azureADAuthenticationAsArmPolicy": {
            "status": "enabled"
          },
          "exportPolicy": {
            "status": "enabled"
          },
          "quarantinePolicy": {
            "status": "disabled"
          },
          "retentionPolicy": {
            "days": 7,
            "status": "disabled"
          },
          "softDeletePolicy": {
            "retentionDays": 7,
            "status": "disabled"
          },
          "trustPolicy": {
            "status": "disabled",
            "type": "Notary"
          }
        },
        "publicNetworkAccess": "Enabled",
        "roleAssignmentMode": "LegacyRegistryPermissions",
        "zoneRedundancy": "Disabled"
      },
      "sku": {
        "name": "Basic",
        "tier": "Basic"
      },
      "type": "Microsoft.ContainerRegistry/registries"
    },
    {
      "apiVersion": "2024-12-01-preview",
      "identity": {
        "type": "None"
      },
      "kind": "GlobalDocumentDB",
      "location": "westeurope",
      "name": "[parameters('databaseAccounts_docufen_staging_name')]",
      "properties": {
        "analyticalStorageConfiguration": {
          "schemaType": "WellDefined"
        },
        "backupPolicy": {
          "periodicModeProperties": {
            "backupIntervalInMinutes": 240,
            "backupRetentionIntervalInHours": 8,
            "backupStorageRedundancy": "Geo"
          },
          "type": "Periodic"
        },
        "capabilities": [],
        "capacityMode": "Serverless",
        "consistencyPolicy": {
          "defaultConsistencyLevel": "Session",
          "maxIntervalInSeconds": 5,
          "maxStalenessPrefix": 100
        },
        "cors": [],
        "databaseAccountOfferType": "Standard",
        "defaultIdentity": "FirstPartyIdentity",
        "diagnosticLogSettings": {
          "enableFullTextQuery": "None"
        },
        "disableKeyBasedMetadataWriteAccess": false,
        "disableLocalAuth": false,
        "enableAnalyticalStorage": false,
        "enableAutomaticFailover": false,
        "enableBurstCapacity": false,
        "enableFreeTier": false,
        "enableMaterializedViews": false,
        "enableMultipleWriteLocations": false,
        "enablePartitionMerge": false,
        "enablePerRegionPerPartitionAutoscale": false,
        "enablePriorityBasedExecution": false,
        "ipRules": [
          {
            "ipAddressOrRange": "192.148.228.32/28"
          },
          {
            "ipAddressOrRange": "61.68.176.55"
          },
          {
            "ipAddressOrRange": "124.19.3.102"
          },
          {
            "ipAddressOrRange": "124.168.126.230"
          },
          {
            "ipAddressOrRange": "124.170.6.152"
          },
          {
            "ipAddressOrRange": "193.82.236.37"
          },
          {
            "ipAddressOrRange": "203.206.94.52"
          },
          {
            "ipAddressOrRange": "210.84.13.111"
          },
          {
            "ipAddressOrRange": "4.210.172.107"
          },
          {
            "ipAddressOrRange": "13.88.56.148"
          },
          {
            "ipAddressOrRange": "13.91.105.215"
          },
          {
            "ipAddressOrRange": "40.91.218.243"
          }
        ],
        "isVirtualNetworkFilterEnabled": false,
        "locations": [
          {
            "failoverPriority": 0,
            "isZoneRedundant": false,
            "locationName": "Australia East"
          }
        ],
        "minimalTlsVersion": "Tls12",
        "networkAclBypass": "None",
        "networkAclBypassResourceIds": [],
        "publicNetworkAccess": "Enabled",
        "virtualNetworkRules": []
      },
      "type": "Microsoft.DocumentDB/databaseAccounts"
    },
    {
      "apiVersion": "2024-12-01-preview",
      "location": "westeurope",
      "name": "[parameters('vaults_docufen_staging_name')]",
      "properties": {
        "accessPolicies": [
          {
            "objectId": "eacd31a2-3e0c-4760-b8fd-9cf5f86be984",
            "permissions": {
              "certificates": [
                "Get",
                "List",
                "Update",
                "Create",
                "Import",
                "Delete",
                "Recover",
                "Backup",
                "Restore",
                "ManageContacts",
                "ManageIssuers",
                "GetIssuers",
                "ListIssuers",
                "SetIssuers",
                "DeleteIssuers"
              ],
              "keys": [
                "Get",
                "List",
                "Update",
                "Create",
                "Import",
                "Delete",
                "Recover",
                "Backup",
                "Restore",
                "Decrypt",
                "Encrypt",
                "UnwrapKey",
                "WrapKey",
                "Verify",
                "Sign",
                "Release",
                "Rotate",
                "GetRotationPolicy",
                "SetRotationPolicy"
              ],
              "secrets": [
                "Get",
                "List",
                "Set",
                "Delete",
                "Recover",
                "Backup",
                "Restore"
              ],
              "storage": [
                "all"
              ]
            },
            "tenantId": "11e9b0fe-e7f6-48fa-b2ee-8f7150b6ebb4"
          }
        ],
        "enablePurgeProtection": true,
        "enableRbacAuthorization": true,
        "enableSoftDelete": true,
        "enabledForDeployment": false,
        "enabledForDiskEncryption": false,
        "enabledForTemplateDeployment": false,
        "networkAcls": {
          "bypass": "AzureServices",
          "defaultAction": "Deny",
          "ipRules": [
            {
              "value": "61.68.177.36/32"
            },
            {
              "value": "192.148.228.41/32"
            },
            {
              "value": "193.82.242.84/32"
            }
          ],
          "virtualNetworkRules": []
        },
        "provisioningState": "Succeeded",
        "publicNetworkAccess": "Enabled",
        "sku": {
          "family": "A",
          "name": "standard"
        },
        "softDeleteRetentionInDays": 90,
        "tenantId": "11e9b0fe-e7f6-48fa-b2ee-8f7150b6ebb4",
        "vaultUri": "[concat('https://', parameters('vaults_docufen_staging_name'), '.vault.azure.net/')]"
      },
      "type": "Microsoft.KeyVault/vaults"
    },
    {
      "apiVersion": "2024-06-01",
      "location": "global",
      "name": "[parameters('privateDnsZones_privatelink_documents_azure_com_name')]",
      "properties": {},
      "type": "Microsoft.Network/privateDnsZones"
    },
    {
      "apiVersion": "2024-06-01",
      "location": "global",
      "name": "[parameters('privateDnsZones_privatelink_vaultcore_azure_net_name')]",
      "properties": {},
      "type": "Microsoft.Network/privateDnsZones"
    },
    {
      "apiVersion": "2024-05-01",
      "location": "westeurope",
      "name": "[parameters('virtualNetworks_vnet_staging_name')]",
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "10.0.0.0/16"
          ]
        },
        "enableDdosProtection": false,
        "encryption": {
          "enabled": false,
          "enforcement": "AllowUnencrypted"
        },
        "privateEndpointVNetPolicies": "Disabled",
        "subnets": [
          {
            "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworks_vnet_staging_name'), 'databases')]",
            "name": "databases",
            "properties": {
              "addressPrefixes": [
                "10.0.1.0/24"
              ],
              "delegations": [],
              "privateEndpointNetworkPolicies": "Disabled",
              "privateLinkServiceNetworkPolicies": "Enabled",
              "serviceEndpoints": [
                {
                  "locations": [
                    "*"
                  ],
                  "service": "Microsoft.AzureCosmosDB"
                }
              ]
            },
            "type": "Microsoft.Network/virtualNetworks/subnets"
          },
          {
            "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworks_vnet_staging_name'), 'privatelinks')]",
            "name": "privatelinks",
            "properties": {
              "addressPrefixes": [
                "10.0.2.0/24"
              ],
              "delegations": [],
              "privateEndpointNetworkPolicies": "Disabled",
              "privateLinkServiceNetworkPolicies": "Enabled",
              "serviceEndpoints": []
            },
            "type": "Microsoft.Network/virtualNetworks/subnets"
          },
          {
            "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworks_vnet_staging_name'), 'default')]",
            "name": "default",
            "properties": {
              "addressPrefix": "10.0.0.0/24",
              "delegations": [
                {
                  "id": "[concat(resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworks_vnet_staging_name'), 'default'), '/delegations/delegation')]",
                  "name": "delegation",
                  "properties": {
                    "serviceName": "Microsoft.Web/serverfarms"
                  },
                  "type": "Microsoft.Network/virtualNetworks/subnets/delegations"
                }
              ],
              "privateEndpointNetworkPolicies": "Disabled",
              "privateLinkServiceNetworkPolicies": "Enabled",
              "serviceEndpoints": []
            },
            "type": "Microsoft.Network/virtualNetworks/subnets"
          },
          {
            "name": "[parameters('containerAppSubnetName')]",
            "properties": {
              "addressPrefix": "10.0.3.0/24",
              "delegations": [
                {
                  "name": "containerAppDelegation",
                  "properties": {
                    "serviceName": "Microsoft.App/environments"
                  }
                }
              ],
              "privateEndpointNetworkPolicies": "Disabled",
              "privateLinkServiceNetworkPolicies": "Enabled"
            }
          }
        ],
        "virtualNetworkPeerings": []
      },
      "type": "Microsoft.Network/virtualNetworks"
    },
    {
      "apiVersion": "2024-01-01",
      "kind": "StorageV2",
      "location": "westeurope",
      "name": "[parameters('storageAccounts_docufenstagingstorage_name')]",
      "properties": {
        "accessTier": "Cool",
        "allowBlobPublicAccess": false,
        "allowCrossTenantReplication": false,
        "allowSharedKeyAccess": true,
        "defaultToOAuthAuthentication": true,
        "dnsEndpointType": "Standard",
        "encryption": {
          "keySource": "Microsoft.Storage",
          "requireInfrastructureEncryption": false,
          "services": {
            "blob": {
              "enabled": true,
              "keyType": "Account"
            },
            "file": {
              "enabled": true,
              "keyType": "Account"
            }
          }
        },
        "largeFileSharesState": "Enabled",
        "minimumTlsVersion": "TLS1_2",
        "networkAcls": {
          "bypass": "AzureServices",
          "defaultAction": "Allow",
          "ipRules": [],
          "resourceAccessRules": [
            {
              "resourceId": "/subscriptions/71bd4c79-d12b-4702-985e-474e9f3a6380/providers/Microsoft.Security/datascanners/StorageDataScanner",
              "tenantId": "11e9b0fe-e7f6-48fa-b2ee-8f7150b6ebb4"
            }
          ],
          "virtualNetworkRules": []
        },
        "publicNetworkAccess": "Enabled",
        "supportsHttpsTrafficOnly": true
      },
      "sku": {
        "name": "Standard_GZRS",
        "tier": "Standard"
      },
      "type": "Microsoft.Storage/storageAccounts"
    },
    {
      "apiVersion": "2024-04-01",
      "kind": "linux",
      "location": "westeurope",
      "name": "[parameters('serverfarms_docufenAppServicePlanstaging_name')]",
      "properties": {
        "elasticScaleEnabled": false,
        "freeOfferExpirationTime": "2023-07-14T23:58:00",
        "hyperV": false,
        "isSpot": false,
        "isXenon": false,
        "maximumElasticWorkerCount": 3,
        "perSiteScaling": false,
        "reserved": true,
        "targetWorkerCount": 0,
        "targetWorkerSizeId": 0,
        "zoneRedundant": true
      },
      "sku": {
        "capacity": 3,
        "family": "P",
        "name": "P2v3",
        "size": "P2v3",
        "tier": "PremiumV3"
      },
      "type": "Microsoft.Web/serverfarms"
    },
    {
      "apiVersion": "2024-04-01",
      "location": "westeurope",
      "name": "[parameters('staticSites_docufenapp_staging_name')]",
      "properties": {
        "allowConfigFileUpdates": true,
        "branch": "release_0.0.1",
        "enterpriseGradeCdnStatus": "Disabled",
        "provider": "GitHub",
        "repositoryUrl": "https://github.com/IntegrityCodes/docufen_client",
        "stagingEnvironmentPolicy": "Enabled"
      },
      "sku": {
        "name": "Standard",
        "tier": "Standard"
      },
      "type": "Microsoft.Web/staticSites"
    },
    {
      "apiVersion": "2025-03-01-preview",
      "dependsOn": [
        "[resourceId('Microsoft.ContainerRegistry/registries', parameters('registries_docufenstaging_name'))]"
      ],
      "name": "[concat(parameters('registries_docufenstaging_name'), '/_repositories_admin')]",
      "properties": {
        "actions": [
          "repositories/*/metadata/read",
          "repositories/*/metadata/write",
          "repositories/*/content/read",
          "repositories/*/content/write",
          "repositories/*/content/delete"
        ],
        "description": "Can perform all read, write and delete operations on the registry"
      },
      "type": "Microsoft.ContainerRegistry/registries/scopeMaps"
    },
    {
      "apiVersion": "2025-03-01-preview",
      "dependsOn": [
        "[resourceId('Microsoft.ContainerRegistry/registries', parameters('registries_docufenstaging_name'))]"
      ],
      "name": "[concat(parameters('registries_docufenstaging_name'), '/_repositories_pull')]",
      "properties": {
        "actions": [
          "repositories/*/content/read"
        ],
        "description": "Can pull any repository of the registry"
      },
      "type": "Microsoft.ContainerRegistry/registries/scopeMaps"
    },
    {
      "apiVersion": "2025-03-01-preview",
      "dependsOn": [
        "[resourceId('Microsoft.ContainerRegistry/registries', parameters('registries_docufenstaging_name'))]"
      ],
      "name": "[concat(parameters('registries_docufenstaging_name'), '/_repositories_pull_metadata_read')]",
      "properties": {
        "actions": [
          "repositories/*/content/read",
          "repositories/*/metadata/read"
        ],
        "description": "Can perform all read operations on the registry"
      },
      "type": "Microsoft.ContainerRegistry/registries/scopeMaps"
    },
    {
      "apiVersion": "2025-03-01-preview",
      "dependsOn": [
        "[resourceId('Microsoft.ContainerRegistry/registries', parameters('registries_docufenstaging_name'))]"
      ],
      "name": "[concat(parameters('registries_docufenstaging_name'), '/_repositories_push')]",
      "properties": {
        "actions": [
          "repositories/*/content/read",
          "repositories/*/content/write"
        ],
        "description": "Can push to any repository of the registry"
      },
      "type": "Microsoft.ContainerRegistry/registries/scopeMaps"
    },
    {
      "apiVersion": "2025-03-01-preview",
      "dependsOn": [
        "[resourceId('Microsoft.ContainerRegistry/registries', parameters('registries_docufenstaging_name'))]"
      ],
      "name": "[concat(parameters('registries_docufenstaging_name'), '/_repositories_push_metadata_write')]",
      "properties": {
        "actions": [
          "repositories/*/metadata/read",
          "repositories/*/metadata/write",
          "repositories/*/content/read",
          "repositories/*/content/write"
        ],
        "description": "Can perform all read and write operations on the registry"
      },
      "type": "Microsoft.ContainerRegistry/registries/scopeMaps"
    },
    {
      "apiVersion": "2024-12-01-preview",
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_docufen_staging_name'))]"
      ],
      "name": "[concat(parameters('databaseAccounts_docufen_staging_name'), '/docufen')]",
      "properties": {
        "resource": {
          "id": "docufen"
        }
      },
      "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases"
    },
    {
      "apiVersion": "2024-12-01-preview",
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_docufen_staging_name'))]"
      ],
      "name": "[concat(parameters('databaseAccounts_docufen_staging_name'), '/00000000-0000-0000-0000-000000000001')]",
      "properties": {
        "assignableScopes": [
          "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_docufen_staging_name'))]"
        ],
        "permissions": [
          {
            "dataActions": [
              "Microsoft.DocumentDB/databaseAccounts/readMetadata",
              "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/executeQuery",
              "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/readChangeFeed",
              "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/items/read"
            ],
            "notDataActions": []
          }
        ],
        "roleName": "Cosmos DB Built-in Data Reader",
        "type": "BuiltInRole"
      },
      "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions"
    },
    {
      "apiVersion": "2024-12-01-preview",
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_docufen_staging_name'))]"
      ],
      "name": "[concat(parameters('databaseAccounts_docufen_staging_name'), '/00000000-0000-0000-0000-000000000002')]",
      "properties": {
        "assignableScopes": [
          "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_docufen_staging_name'))]"
        ],
        "permissions": [
          {
            "dataActions": [
              "Microsoft.DocumentDB/databaseAccounts/readMetadata",
              "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/*",
              "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/items/*"
            ],
            "notDataActions": []
          }
        ],
        "roleName": "Cosmos DB Built-in Data Contributor",
        "type": "BuiltInRole"
      },
      "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions"
    },
    {
      "apiVersion": "2024-12-01-preview",
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_docufen_staging_name'))]"
      ],
      "name": "[concat(parameters('databaseAccounts_docufen_staging_name'), '/ca838582-ee29-4dd9-a243-2275001a96d1')]",
      "properties": {
        "assignableScopes": [
          "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_docufen_staging_name'))]"
        ],
        "permissions": [
          {
            "dataActions": [
              "Microsoft.DocumentDB/databaseAccounts/readMetadata",
              "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/items/*",
              "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/*"
            ],
            "notDataActions": []
          }
        ],
        "roleName": "PasswordlessReadWrite",
        "type": "CustomRole"
      },
      "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions"
    },
    {
      "apiVersion": "2024-12-01-preview",
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_docufen_staging_name'))]"
      ],
      "name": "[concat(parameters('databaseAccounts_docufen_staging_name'), '/00000000-0000-0000-0000-000000000001')]",
      "properties": {
        "assignableScopes": [
          "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_docufen_staging_name'))]"
        ],
        "permissions": [
          {
            "dataActions": [
              "Microsoft.DocumentDB/databaseAccounts/readMetadata",
              "Microsoft.DocumentDB/databaseAccounts/tables/containers/executeQuery",
              "Microsoft.DocumentDB/databaseAccounts/tables/containers/readChangeFeed",
              "Microsoft.DocumentDB/databaseAccounts/tables/containers/entities/read"
            ],
            "notDataActions": []
          }
        ],
        "roleName": "Cosmos DB Built-in Data Reader",
        "type": "BuiltInRole"
      },
      "type": "Microsoft.DocumentDB/databaseAccounts/tableRoleDefinitions"
    },
    {
      "apiVersion": "2024-12-01-preview",
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_docufen_staging_name'))]"
      ],
      "name": "[concat(parameters('databaseAccounts_docufen_staging_name'), '/00000000-0000-0000-0000-000000000002')]",
      "properties": {
        "assignableScopes": [
          "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_docufen_staging_name'))]"
        ],
        "permissions": [
          {
            "dataActions": [
              "Microsoft.DocumentDB/databaseAccounts/readMetadata",
              "Microsoft.DocumentDB/databaseAccounts/tables/*",
              "Microsoft.DocumentDB/databaseAccounts/tables/containers/*",
              "Microsoft.DocumentDB/databaseAccounts/tables/containers/entities/*"
            ],
            "notDataActions": []
          }
        ],
        "roleName": "Cosmos DB Built-in Data Contributor",
        "type": "BuiltInRole"
      },
      "type": "Microsoft.DocumentDB/databaseAccounts/tableRoleDefinitions"
    },
    {
      "apiVersion": "2025-02-15",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccounts_docufenstagingstorage_name'))]"
      ],
      "location": "westeurope",
      "name": "[parameters('systemTopics_docufenstagingstorage_f33197b9_a5d1_4f96_a661_7b8ffa72c06c_name')]",
      "properties": {
        "source": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccounts_docufenstagingstorage_name'))]",
        "topicType": "microsoft.storage.storageaccounts"
      },
      "type": "Microsoft.EventGrid/systemTopics"
    },
    {
      "apiVersion": "2024-12-01-preview",
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', parameters('vaults_docufen_staging_name'))]"
      ],
      "location": "westeurope",
      "name": "[concat(parameters('vaults_docufen_staging_name'), '/keyvaultstagingendpoint')]",
      "properties": {
        "privateEndpoint": {},
        "privateLinkServiceConnectionState": {
          "actionsRequired": "None",
          "status": "Approved"
        },
        "provisioningState": "Succeeded"
      },
      "type": "Microsoft.KeyVault/vaults/privateEndpointConnections"
    },
    {
      "apiVersion": "2024-12-01-preview",
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', parameters('vaults_docufen_staging_name'))]"
      ],
      "location": "westeurope",
      "name": "[concat(parameters('vaults_docufen_staging_name'), '/ADDINSECRET')]",
      "properties": {
        "attributes": {
          "enabled": true
        }
      },
      "type": "Microsoft.KeyVault/vaults/secrets"
    },
    {
      "apiVersion": "2024-12-01-preview",
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', parameters('vaults_docufen_staging_name'))]"
      ],
      "location": "westeurope",
      "name": "[concat(parameters('vaults_docufen_staging_name'), '/CERTIFICATE')]",
      "properties": {
        "attributes": {
          "enabled": true
        }
      },
      "type": "Microsoft.KeyVault/vaults/secrets"
    },
    {
      "apiVersion": "2024-12-01-preview",
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', parameters('vaults_docufen_staging_name'))]"
      ],
      "location": "westeurope",
      "name": "[concat(parameters('vaults_docufen_staging_name'), '/COOKIESECRET')]",
      "properties": {
        "attributes": {
          "enabled": true
        }
      },
      "tags": {
        "file-encoding": "utf-8"
      },
      "type": "Microsoft.KeyVault/vaults/secrets"
    },
    {
      "apiVersion": "2024-12-01-preview",
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', parameters('vaults_docufen_staging_name'))]"
      ],
      "location": "westeurope",
      "name": "[concat(parameters('vaults_docufen_staging_name'), '/COSMOSKEY')]",
      "properties": {
        "attributes": {
          "enabled": true
        }
      },
      "tags": {
        "file-encoding": "utf-8"
      },
      "type": "Microsoft.KeyVault/vaults/secrets"
    },
    {
      "apiVersion": "2024-06-01",
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZones_privatelink_documents_azure_com_name'))]"
      ],
      "name": "[concat(parameters('privateDnsZones_privatelink_documents_azure_com_name'), '/docufen-staging')]",
      "properties": {
        "aRecords": [
          {
            "ipv4Address": "10.0.1.4"
          }
        ],
        "metadata": {
          "creator": "created by private endpoint cosmosstagingendpoint with resource guid 265fcfa6-2b75-4030-ac48-d14716f82bb8"
        },
        "ttl": 10
      },
      "type": "Microsoft.Network/privateDnsZones/A"
    },
    {
      "apiVersion": "2024-06-01",
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZones_privatelink_vaultcore_azure_net_name'))]"
      ],
      "name": "[concat(parameters('privateDnsZones_privatelink_vaultcore_azure_net_name'), '/docufen-staging')]",
      "properties": {
        "aRecords": [
          {
            "ipv4Address": "10.0.2.4"
          }
        ],
        "metadata": {
          "creator": "created by private endpoint keyvaultstagingendpoint with resource guid 63981a03-bb0f-4f60-84f1-2412f753d89d"
        },
        "ttl": 10
      },
      "type": "Microsoft.Network/privateDnsZones/A"
    },
    {
      "apiVersion": "2024-06-01",
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZones_privatelink_documents_azure_com_name'))]"
      ],
      "name": "[concat(parameters('privateDnsZones_privatelink_documents_azure_com_name'), '/docufen-staging-westeurope')]",
      "properties": {
        "aRecords": [
          {
            "ipv4Address": "10.0.1.5"
          }
        ],
        "metadata": {
          "creator": "created by private endpoint cosmosstagingendpoint with resource guid 265fcfa6-2b75-4030-ac48-d14716f82bb8"
        },
        "ttl": 10
      },
      "type": "Microsoft.Network/privateDnsZones/A"
    },
    {
      "apiVersion": "2024-06-01",
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZones_privatelink_documents_azure_com_name'))]"
      ],
      "name": "[concat(parameters('privateDnsZones_privatelink_documents_azure_com_name'), '/@')]",
      "properties": {
        "soaRecord": {
          "email": "azureprivatedns-host.microsoft.com",
          "expireTime": 2419200,
          "host": "azureprivatedns.net",
          "minimumTtl": 10,
          "refreshTime": 3600,
          "retryTime": 300,
          "serialNumber": 1
        },
        "ttl": 3600
      },
      "type": "Microsoft.Network/privateDnsZones/SOA"
    },
    {
      "apiVersion": "2024-06-01",
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZones_privatelink_vaultcore_azure_net_name'))]"
      ],
      "name": "[concat(parameters('privateDnsZones_privatelink_vaultcore_azure_net_name'), '/@')]",
      "properties": {
        "soaRecord": {
          "email": "azureprivatedns-host.microsoft.com",
          "expireTime": 2419200,
          "host": "azureprivatedns.net",
          "minimumTtl": 10,
          "refreshTime": 3600,
          "retryTime": 300,
          "serialNumber": 1
        },
        "ttl": 3600
      },
      "type": "Microsoft.Network/privateDnsZones/SOA"
    },
    {
      "apiVersion": "2024-05-01",
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworks_vnet_staging_name'))]"
      ],
      "name": "[concat(parameters('virtualNetworks_vnet_staging_name'), '/databases')]",
      "properties": {
        "addressPrefixes": [
          "10.0.1.0/24"
        ],
        "delegations": [],
        "privateEndpointNetworkPolicies": "Disabled",
        "privateLinkServiceNetworkPolicies": "Enabled",
        "serviceEndpoints": [
          {
            "locations": [
              "*"
            ],
            "service": "Microsoft.AzureCosmosDB"
          }
        ]
      },
      "type": "Microsoft.Network/virtualNetworks/subnets"
    },
    {
      "apiVersion": "2024-05-01",
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworks_vnet_staging_name'))]"
      ],
      "name": "[concat(parameters('virtualNetworks_vnet_staging_name'), '/default')]",
      "properties": {
        "addressPrefix": "10.0.0.0/24",
        "delegations": [
          {
            "id": "[concat(resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworks_vnet_staging_name'), 'default'), '/delegations/delegation')]",
            "name": "delegation",
            "properties": {
              "serviceName": "Microsoft.Web/serverfarms"
            },
            "type": "Microsoft.Network/virtualNetworks/subnets/delegations"
          }
        ],
        "privateEndpointNetworkPolicies": "Disabled",
        "privateLinkServiceNetworkPolicies": "Enabled",
        "serviceEndpoints": []
      },
      "type": "Microsoft.Network/virtualNetworks/subnets"
    },
    {
      "apiVersion": "2024-05-01",
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworks_vnet_staging_name'))]"
      ],
      "name": "[concat(parameters('virtualNetworks_vnet_staging_name'), '/privatelinks')]",
      "properties": {
        "addressPrefixes": [
          "10.0.2.0/24"
        ],
        "delegations": [],
        "privateEndpointNetworkPolicies": "Disabled",
        "privateLinkServiceNetworkPolicies": "Enabled",
        "serviceEndpoints": []
      },
      "type": "Microsoft.Network/virtualNetworks/subnets"
    },
    {
      "apiVersion": "2024-01-01",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccounts_docufenstagingstorage_name'))]"
      ],
      "name": "[concat(parameters('storageAccounts_docufenstagingstorage_name'), '/default')]",
      "properties": {
        "containerDeleteRetentionPolicy": {
          "days": 7,
          "enabled": true
        },
        "cors": {
          "corsRules": []
        },
        "deleteRetentionPolicy": {
          "allowPermanentDelete": false,
          "enabled": false
        }
      },
      "sku": {
        "name": "Standard_GZRS",
        "tier": "Standard"
      },
      "type": "Microsoft.Storage/storageAccounts/blobServices"
    },
    {
      "apiVersion": "2024-01-01",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccounts_docufenstagingstorage_name'))]"
      ],
      "name": "[concat(parameters('storageAccounts_docufenstagingstorage_name'), '/default')]",
      "properties": {
        "cors": {
          "corsRules": []
        },
        "protocolSettings": {
          "smb": {}
        },
        "shareDeleteRetentionPolicy": {
          "days": 7,
          "enabled": true
        }
      },
      "sku": {
        "name": "Standard_GZRS",
        "tier": "Standard"
      },
      "type": "Microsoft.Storage/storageAccounts/fileServices"
    },
    {
      "apiVersion": "2024-01-01",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccounts_docufenstagingstorage_name'))]"
      ],
      "name": "[concat(parameters('storageAccounts_docufenstagingstorage_name'), '/default')]",
      "properties": {
        "cors": {
          "corsRules": []
        }
      },
      "type": "Microsoft.Storage/storageAccounts/queueServices"
    },
    {
      "apiVersion": "2024-01-01",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccounts_docufenstagingstorage_name'))]"
      ],
      "name": "[concat(parameters('storageAccounts_docufenstagingstorage_name'), '/default')]",
      "properties": {
        "cors": {
          "corsRules": []
        }
      },
      "type": "Microsoft.Storage/storageAccounts/tableServices"
    },
    {
      "apiVersion": "2024-04-01",
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', parameters('sites_docufen_staging_name'))]"
      ],
      "location": "westeurope",
      "name": "[concat(parameters('sites_docufen_staging_name'), '/ftp')]",
      "properties": {
        "allow": true
      },
      "type": "Microsoft.Web/sites/basicPublishingCredentialsPolicies"
    },
    {
      "apiVersion": "2024-04-01",
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', parameters('sites_docufen_staging_name'))]"
      ],
      "location": "westeurope",
      "name": "[concat(parameters('sites_docufen_staging_name'), '/scm')]",
      "properties": {
        "allow": true
      },
      "type": "Microsoft.Web/sites/basicPublishingCredentialsPolicies"
    },
    {
      "apiVersion": "2024-04-01",
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', parameters('sites_docufen_staging_name'))]"
      ],
      "location": "westeurope",
      "name": "[concat(parameters('sites_docufen_staging_name'), '/web')]",
      "properties": {
        "acrUseManagedIdentityCreds": false,
        "alwaysOn": false,
        "autoHealEnabled": false,
        "azureStorageAccounts": {},
        "defaultDocuments": [
          "Default.htm",
          "Default.html",
          "Default.asp",
          "index.htm",
          "index.html",
          "iisstart.htm",
          "default.aspx",
          "index.php",
          "hostingstart.html"
        ],
        "detailedErrorLoggingEnabled": false,
        "elasticWebAppScaleLimit": 0,
        "experiments": {
          "rampUpRules": []
        },
        "ftpsState": "FtpsOnly",
        "functionsRuntimeScaleMonitoringEnabled": false,
        "healthCheckPath": "/api/",
        "http20Enabled": true,
        "httpLoggingEnabled": true,
        "ipSecurityRestrictions": [
          {
            "action": "Allow",
            "description": "Allow all access",
            "ipAddress": "Any",
            "name": "Allow all",
            "priority": 2147483647
          }
        ],
        "ipSecurityRestrictionsDefaultAction": "Allow",
        "linuxFxVersion": "DOCKER|ghcr.io/integritycodes/docufen_server:3972457ae9a2e6660c1968262918b7941b4fcca1",
        "loadBalancing": "LeastRequests",
        "localMySqlEnabled": false,
        "logsDirectorySizeLimit": 35,
        "managedPipelineMode": "Integrated",
        "managedServiceIdentityId": 8589,
        "minTlsVersion": "1.2",
        "minimumElasticInstanceCount": 0,
        "netFrameworkVersion": "v4.0",
        "numberOfWorkers": 1,
        "preWarmedInstanceCount": 0,
        "publicNetworkAccess": "Enabled",
        "publishingUsername": "$docufen-staging",
        "remoteDebuggingEnabled": false,
        "requestTracingEnabled": false,
        "scmIpSecurityRestrictions": [
          {
            "action": "Allow",
            "description": "Allow all access",
            "ipAddress": "Any",
            "name": "Allow all",
            "priority": 2147483647
          }
        ],
        "scmIpSecurityRestrictionsDefaultAction": "Allow",
        "scmIpSecurityRestrictionsUseMain": false,
        "scmMinTlsVersion": "1.2",
        "scmType": "None",
        "use32BitWorkerProcess": true,
        "virtualApplications": [
          {
            "physicalPath": "site\\wwwroot",
            "preloadEnabled": false,
            "virtualPath": "/"
          }
        ],
        "vnetName": "44487e09-372b-4ac0-b171-970c5c17d53f_default",
        "vnetPrivatePortsCount": 0,
        "vnetRouteAllEnabled": true,
        "webSocketsEnabled": false
      },
      "type": "Microsoft.Web/sites/config"
    },
    {
      "apiVersion": "2024-04-01",
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', parameters('sites_docufen_staging_name'))]"
      ],
      "location": "westeurope",
      "name": "[concat(parameters('sites_docufen_staging_name'), '/', parameters('sites_docufen_staging_name'), '.azurewebsites.net')]",
      "properties": {
        "hostNameType": "Verified",
        "siteName": "docufen-staging"
      },
      "type": "Microsoft.Web/sites/hostNameBindings"
    },
    {
      "apiVersion": "2024-04-01",
      "dependsOn": [
        "[resourceId('Microsoft.Web/staticSites', parameters('staticSites_docufenapp_staging_name'))]"
      ],
      "location": "westeurope",
      "name": "[concat(parameters('staticSites_docufenapp_staging_name'), '/default')]",
      "properties": {
        "applicableEnvironmentsMode": "SpecifiedEnvironments"
      },
      "type": "Microsoft.Web/staticSites/basicAuth"
    },
    {
      "apiVersion": "2024-12-01-preview",
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('databaseAccounts_docufen_staging_name'), 'docufen')]",
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_docufen_staging_name'))]"
      ],
      "name": "[concat(parameters('databaseAccounts_docufen_staging_name'), '/docufen/invited_users')]",
      "properties": {
        "resource": {
          "computedProperties": [],
          "conflictResolutionPolicy": {
            "conflictResolutionPath": "/_ts",
            "mode": "LastWriterWins"
          },
          "id": "invited_users",
          "indexingPolicy": {
            "automatic": true,
            "excludedPaths": [
              {
                "path": "/\"_etag\"/?"
              }
            ],
            "includedPaths": [
              {
                "path": "/*"
              }
            ],
            "indexingMode": "consistent"
          },
          "partitionKey": {
            "kind": "Hash",
            "paths": [
              "/id"
            ],
            "version": 2
          },
          "uniqueKeyPolicy": {
            "uniqueKeys": []
          }
        }
      },
      "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers"
    },
    {
      "apiVersion": "2024-12-01-preview",
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('databaseAccounts_docufen_staging_name'), 'docufen')]",
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_docufen_staging_name'))]"
      ],
      "name": "[concat(parameters('databaseAccounts_docufen_staging_name'), '/docufen/license')]",
      "properties": {
        "resource": {
          "conflictResolutionPolicy": {
            "conflictResolutionPath": "/_ts",
            "mode": "LastWriterWins"
          },
          "id": "license",
          "indexingPolicy": {
            "automatic": true,
            "excludedPaths": [
              {
                "path": "/\"_etag\"/?"
              }
            ],
            "includedPaths": [
              {
                "path": "/*"
              }
            ],
            "indexingMode": "consistent"
          },
          "partitionKey": {
            "kind": "Hash",
            "paths": [
              "/id"
            ]
          },
          "uniqueKeyPolicy": {
            "uniqueKeys": []
          }
        }
      },
      "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers"
    },
    {
      "apiVersion": "2024-12-01-preview",
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('databaseAccounts_docufen_staging_name'), 'docufen')]",
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_docufen_staging_name'))]"
      ],
      "name": "[concat(parameters('databaseAccounts_docufen_staging_name'), '/docufen/users')]",
      "properties": {
        "resource": {
          "computedProperties": [],
          "conflictResolutionPolicy": {
            "conflictResolutionPath": "/_ts",
            "mode": "LastWriterWins"
          },
          "defaultTtl": 172800,
          "id": "users",
          "indexingPolicy": {
            "automatic": true,
            "excludedPaths": [
              {
                "path": "/\"_etag\"/?"
              }
            ],
            "includedPaths": [
              {
                "path": "/*"
              }
            ],
            "indexingMode": "consistent"
          },
          "partitionKey": {
            "kind": "Hash",
            "paths": [
              "/id"
            ]
          },
          "uniqueKeyPolicy": {
            "uniqueKeys": []
          }
        }
      },
      "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers"
    },
    {
      "apiVersion": "2024-12-01-preview",
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_docufen_staging_name'))]",
        "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions', parameters('databaseAccounts_docufen_staging_name'), '00000000-0000-0000-0000-000000000002')]"
      ],
      "name": "[concat(parameters('databaseAccounts_docufen_staging_name'), '/25e6099e-67e1-4283-bef9-1dc68e7dd0ec')]",
      "properties": {
        "principalId": "eacd31a2-3e0c-4760-b8fd-9cf5f86be984",
        "roleDefinitionId": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions', parameters('databaseAccounts_docufen_staging_name'), '00000000-0000-0000-0000-000000000002')]",
        "scope": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_docufen_staging_name'))]"
      },
      "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments"
    },
    {
      "apiVersion": "2024-12-01-preview",
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_docufen_staging_name'))]",
        "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions', parameters('databaseAccounts_docufen_staging_name'), 'ca838582-ee29-4dd9-a243-2275001a96d1')]"
      ],
      "name": "[concat(parameters('databaseAccounts_docufen_staging_name'), '/b6211350-2b42-40c8-b52a-079dcbda55c0')]",
      "properties": {
        "principalId": "cd7e0edd-bef6-4dde-b6ce-45fc38fdc378",
        "roleDefinitionId": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions', parameters('databaseAccounts_docufen_staging_name'), 'ca838582-ee29-4dd9-a243-2275001a96d1')]",
        "scope": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_docufen_staging_name'))]"
      },
      "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments"
    },
    {
      "apiVersion": "2024-12-01-preview",
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_docufen_staging_name'))]",
        "[resourceId('Microsoft.DocumentDB/databaseAccounts/tableRoleDefinitions', parameters('databaseAccounts_docufen_staging_name'), '00000000-0000-0000-0000-000000000002')]"
      ],
      "name": "[concat(parameters('databaseAccounts_docufen_staging_name'), '/6efd2d21-dfe5-48cc-b119-5a51741d65a6')]",
      "properties": {
        "principalId": "eacd31a2-3e0c-4760-b8fd-9cf5f86be984",
        "roleDefinitionId": "[resourceId('Microsoft.DocumentDB/databaseAccounts/tableRoleDefinitions', parameters('databaseAccounts_docufen_staging_name'), '00000000-0000-0000-0000-000000000002')]",
        "scope": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_docufen_staging_name'))]"
      },
      "type": "Microsoft.DocumentDB/databaseAccounts/tableRoleAssignments"
    },
    {
      "apiVersion": "2024-06-01",
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZones_privatelink_documents_azure_com_name'))]",
        "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworks_vnet_staging_name'))]"
      ],
      "location": "global",
      "name": "[concat(parameters('privateDnsZones_privatelink_documents_azure_com_name'), '/jftsqsxvykfsi')]",
      "properties": {
        "registrationEnabled": false,
        "virtualNetwork": {
          "id": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworks_vnet_staging_name'))]"
        }
      },
      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks"
    },
    {
      "apiVersion": "2024-06-01",
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZones_privatelink_vaultcore_azure_net_name'))]",
        "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworks_vnet_staging_name'))]"
      ],
      "location": "global",
      "name": "[concat(parameters('privateDnsZones_privatelink_vaultcore_azure_net_name'), '/jftsqsxvykfsi')]",
      "properties": {
        "registrationEnabled": false,
        "virtualNetwork": {
          "id": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworks_vnet_staging_name'))]"
        }
      },
      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks"
    },
    {
      "apiVersion": "2024-05-01",
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_docufen_staging_name'))]",
        "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworks_vnet_staging_name'), 'databases')]"
      ],
      "location": "westeurope",
      "name": "[parameters('privateEndpoints_cosmosstagingendpoint_name')]",
      "properties": {
        "customDnsConfigs": [],
        "customNetworkInterfaceName": "[concat(parameters('privateEndpoints_cosmosstagingendpoint_name'), '-nic')]",
        "ipConfigurations": [],
        "manualPrivateLinkServiceConnections": [],
        "privateLinkServiceConnections": [
          {
            "id": "[concat(resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpoints_cosmosstagingendpoint_name')), concat('/privateLinkServiceConnections/', parameters('privateEndpoints_cosmosstagingendpoint_name')))]",
            "name": "[parameters('privateEndpoints_cosmosstagingendpoint_name')]",
            "properties": {
              "groupIds": [
                "Sql"
              ],
              "privateLinkServiceConnectionState": {
                "actionsRequired": "None",
                "status": "Approved"
              },
              "privateLinkServiceId": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_docufen_staging_name'))]"
            }
          }
        ],
        "subnet": {
          "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworks_vnet_staging_name'), 'databases')]"
        }
      },
      "type": "Microsoft.Network/privateEndpoints"
    },
    {
      "apiVersion": "2024-05-01",
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', parameters('vaults_docufen_staging_name'))]",
        "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworks_vnet_staging_name'), 'privatelinks')]"
      ],
      "location": "westeurope",
      "name": "[parameters('privateEndpoints_keyvaultstagingendpoint_name')]",
      "properties": {
        "customDnsConfigs": [],
        "customNetworkInterfaceName": "[concat(parameters('privateEndpoints_keyvaultstagingendpoint_name'), '-nic')]",
        "ipConfigurations": [],
        "manualPrivateLinkServiceConnections": [],
        "privateLinkServiceConnections": [
          {
            "id": "[concat(resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpoints_keyvaultstagingendpoint_name')), concat('/privateLinkServiceConnections/', parameters('privateEndpoints_keyvaultstagingendpoint_name')))]",
            "name": "[parameters('privateEndpoints_keyvaultstagingendpoint_name')]",
            "properties": {
              "groupIds": [
                "vault"
              ],
              "privateLinkServiceConnectionState": {
                "actionsRequired": "None",
                "status": "Approved"
              },
              "privateLinkServiceId": "[resourceId('Microsoft.KeyVault/vaults', parameters('vaults_docufen_staging_name'))]"
            }
          }
        ],
        "subnet": {
          "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworks_vnet_staging_name'), 'privatelinks')]"
        }
      },
      "type": "Microsoft.Network/privateEndpoints"
    },
    {
      "apiVersion": "2024-05-01",
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpoints_cosmosstagingendpoint_name'))]",
        "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZones_privatelink_documents_azure_com_name'))]"
      ],
      "name": "[concat(parameters('privateEndpoints_cosmosstagingendpoint_name'), '/default')]",
      "properties": {
        "privateDnsZoneConfigs": [
          {
            "name": "privatelink-documents-azure-com",
            "properties": {
              "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZones_privatelink_documents_azure_com_name'))]"
            }
          }
        ]
      },
      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups"
    },
    {
      "apiVersion": "2024-05-01",
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpoints_keyvaultstagingendpoint_name'))]",
        "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZones_privatelink_vaultcore_azure_net_name'))]"
      ],
      "name": "[concat(parameters('privateEndpoints_keyvaultstagingendpoint_name'), '/default')]",
      "properties": {
        "privateDnsZoneConfigs": [
          {
            "name": "privatelink-vaultcore-azure-net",
            "properties": {
              "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', parameters('privateDnsZones_privatelink_vaultcore_azure_net_name'))]"
            }
          }
        ]
      },
      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups"
    },
    {
      "apiVersion": "2024-04-01",
      "dependsOn": [
        "[resourceId('Microsoft.Web/serverfarms', parameters('serverfarms_docufenAppServicePlanstaging_name'))]",
        "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworks_vnet_staging_name'), 'default')]"
      ],
      "identity": {
        "type": "SystemAssigned"
      },
      "kind": "app,linux,container",
      "location": "westeurope",
      "name": "[parameters('sites_docufen_staging_name')]",
      "properties": {
        "clientAffinityEnabled": true,
        "clientCertEnabled": false,
        "clientCertMode": "Required",
        "containerSize": 0,
        "customDomainVerificationId": "46F9D938453D90F27D303CFC8A4F4D24173E59ACDAD015ECDCA4AA2CB92CB97D",
        "dailyMemoryTimeQuota": 0,
        "dnsConfiguration": {},
        "enabled": true,
        "endToEndEncryptionEnabled": false,
        "hostNameSslStates": [
          {
            "hostType": "Standard",
            "name": "[concat(parameters('sites_docufen_staging_name'), '.azurewebsites.net')]",
            "sslState": "Disabled"
          },
          {
            "hostType": "Repository",
            "name": "[concat(parameters('sites_docufen_staging_name'), '.scm.azurewebsites.net')]",
            "sslState": "Disabled"
          }
        ],
        "hostNamesDisabled": false,
        "httpsOnly": true,
        "hyperV": false,
        "ipMode": "IPv4",
        "isXenon": false,
        "keyVaultReferenceIdentity": "SystemAssigned",
        "publicNetworkAccess": "Enabled",
        "redundancyMode": "None",
        "reserved": true,
        "scmSiteAlsoStopped": false,
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('serverfarms_docufenAppServicePlanstaging_name'))]",
        "siteConfig": {
          "acrUseManagedIdentityCreds": false,
          "alwaysOn": false,
          "functionAppScaleLimit": 0,
          "http20Enabled": true,
          "linuxFxVersion": "DOCKER|ghcr.io/integritycodes/docufen_server:3972457ae9a2e6660c1968262918b7941b4fcca1",
          "minimumElasticInstanceCount": 0,
          "numberOfWorkers": 1
        },
        "storageAccountRequired": false,
        "virtualNetworkSubnetId": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworks_vnet_staging_name'), 'default')]",
        "vnetBackupRestoreEnabled": false,
        "vnetContentShareEnabled": false,
        "vnetImagePullEnabled": false,
        "vnetRouteAllEnabled": true
      },
      "type": "Microsoft.Web/sites"
    },
    {
      "apiVersion": "2024-04-01",
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', parameters('sites_docufen_staging_name'))]",
        "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworks_vnet_staging_name'), 'default')]"
      ],
      "location": "westeurope",
      "name": "[concat(parameters('sites_docufen_staging_name'), '/44487e09-372b-4ac0-b171-970c5c17d53f_default')]",
      "properties": {
        "isSwift": true,
        "vnetResourceId": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworks_vnet_staging_name'), 'default')]"
      },
      "type": "Microsoft.Web/sites/virtualNetworkConnections"
    },
    {
      "apiVersion": "2024-04-01",
      "dependsOn": [
        "[resourceId('Microsoft.Web/staticSites', parameters('staticSites_docufenapp_staging_name'))]",
        "[resourceId('Microsoft.Web/sites', parameters('sites_docufen_staging_name'))]"
      ],
      "location": "westeurope",
      "name": "[concat(parameters('staticSites_docufenapp_staging_name'), '/backend1')]",
      "properties": {
        "backendResourceId": "[resourceId('Microsoft.Web/sites', parameters('sites_docufen_staging_name'))]",
        "region": "westeurope"
      },
      "type": "Microsoft.Web/staticSites/linkedBackends"
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2022-10-01",
      "name": "[parameters('workspaces_containerapp_name')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "sku": {
          "name": "PerGB2018"
        },
        "retentionInDays": 30
      }
    },
    {
      "type": "Microsoft.App/managedEnvironments",
      "apiVersion": "2024-03-01",
      "name": "[parameters('managedEnvironments_name')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaces_containerapp_name'))]",
        "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworks_vnet_staging_name'))]"
      ],
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "appLogsConfiguration": {
          "destination": "log-analytics",
          "logAnalyticsConfiguration": {
            "customerId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaces_containerapp_name')), '2022-10-01').customerId]",
            "sharedKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaces_containerapp_name')), '2022-10-01').primarySharedKey]"
          }
        },
        "vnetConfiguration": {
          "infrastructureSubnetId": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworks_vnet_staging_name'), parameters('containerAppSubnetName'))]"
        },
        "workloadProfiles": [
          {
            "name": "Consumption",
            "workloadProfileType": "Consumption"
          }
        ]
      }
    },
    {
      "type": "Microsoft.App/containerApps",
      "apiVersion": "2024-03-01",
      "name": "[parameters('containerApps_docufen_admin_name')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[resourceId('Microsoft.App/managedEnvironments', parameters('managedEnvironments_name'))]"
      ],
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', parameters('managedEnvironments_name'))]",
        "configuration": {
          "ingress": {
            "external": true,
            "targetPort": "[parameters('containerPort')]",
            "transport": "auto",
            "allowInsecure": false,
            "traffic": [
              {
                "latestRevision": true,
                "weight": 100
              }
            ]
          },
          "registries": "[if(and(not(empty(parameters('githubUsername'))), not(empty(parameters('githubToken')))), createArray(createObject('server', 'ghcr.io', 'username', parameters('githubUsername'), 'passwordSecretRef', 'github-token')), createArray(createObject('server', reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('registries_docufenstaging_name')), '2023-01-01-preview').loginServer, 'identity', 'system')))]",
          "secrets": "[if(and(not(empty(parameters('githubUsername'))), not(empty(parameters('githubToken')))), createArray(createObject('name', 'github-token', 'value', parameters('githubToken'))), createArray())]"
        },
        "template": {
          "containers": [
            {
              "name": "admin-container",
              "image": "[parameters('containerImage')]",
              "resources": {
                "cpu": 0.5,
                "memory": "1Gi"
              },
              "env": [
                {
                  "name": "AZURE_COSMOS_ENDPOINT",
                  "value": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_docufen_staging_name')), '2024-05-15').documentEndpoint]"
                },
                {
                  "name": "AZURE_KEYVAULT_URI",
                  "value": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('vaults_docufen_staging_name')), '2023-02-01').vaultUri]"
                }
              ]
            }
          ],
          "scale": {
            "minReplicas": 1,
            "maxReplicas": 10,
            "rules": [
              {
                "name": "http-scale",
                "http": {
                  "metadata": {
                    "concurrentRequests": "100"
                  }
                }
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[guid(resourceId('Microsoft.App/containerApps', parameters('containerApps_docufen_admin_name')), 'keyvault')]",
      "dependsOn": [
        "[resourceId('Microsoft.App/containerApps', parameters('containerApps_docufen_admin_name'))]"
      ],
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]",
        "principalId": "[reference(resourceId('Microsoft.App/containerApps', parameters('containerApps_docufen_admin_name')), '2024-03-01', 'full').identity.principalId]",
        "principalType": "ServicePrincipal",
        "scope": "[resourceId('Microsoft.KeyVault/vaults', parameters('vaults_docufen_staging_name'))]"
      }
    },
    {
      "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
      "apiVersion": "2024-05-15",
      "name": "[concat(parameters('databaseAccounts_docufen_staging_name'), '/', guid(resourceId('Microsoft.App/containerApps', parameters('containerApps_docufen_admin_name')), 'cosmos'))]",
      "dependsOn": [
        "[resourceId('Microsoft.App/containerApps', parameters('containerApps_docufen_admin_name'))]",
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_docufen_staging_name'))]"
      ],
      "properties": {
        "roleDefinitionId": "[concat(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_docufen_staging_name')), '/sqlRoleDefinitions/00000000-0000-0000-0000-000000000002')]",
        "principalId": "[reference(resourceId('Microsoft.App/containerApps', parameters('containerApps_docufen_admin_name')), '2024-03-01', 'full').identity.principalId]",
        "scope": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_docufen_staging_name'))]"
      }
    }
  ],
  "variables": {},
  "outputs": {
    "containerAppFQDN": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('containerApps_docufen_admin_name'))).configuration.ingress.fqdn]"
    },
    "containerAppManagedIdentity": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('containerApps_docufen_admin_name')), '2024-03-01', 'full').identity.principalId]"
    }
  }
}